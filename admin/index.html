<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Retail Playbook CMS – Debug</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 16px; line-height: 1.4; }
  .ok { color: #1a7f37 } .warn { color: #b54708 } .err { color: #b42318 }
  code { background:#f6f8fa; padding:2px 4px; border-radius:4px }
  button { padding:8px 12px; }
</style>
</head>
<body>
  <h1>CMS Debug</h1>
  <div id="log"></div>
  <div style="margin:12px 0">
    <button id="btn-auth" type="button">Open GitHub Login (Worker)</button>
    <button id="btn-reinit" type="button">Force CMS.init()</button>
    <button id="btn-clear" type="button">Clear token</button>
  </div>

  <!-- Load Decap once -->
  <script src="https://unpkg.com/decap-cms@3.8.3/dist/decap-cms.js"></script>

  <script>
  const logEl = document.getElementById('log');
  const log = (msg, cls='') => {
    const p = document.createElement('div'); p.className = cls; p.innerHTML = msg; logEl.appendChild(p);
  };

  (async function boot() {
    try {
      log('<b>Step 1:</b> Loading Decap…');
      if (!window.CMS) return log('Decap script not found', 'err');

      // Report current token (if any)
      const raw = localStorage.getItem('decap-cms.user');
      if (raw) {
        log('Found saved token in <code>localStorage</code>.', 'ok');
      } else {
        log('No saved token in <code>localStorage</code>.', 'warn');
      }

      // Fetch config.yml (what Decap needs)
      log('<b>Step 2:</b> Fetching <code>/admin/config.yml</code>…');
      let cfgStatus = 0, cfgType = '', cfgHead = '';
      try {
        const r = await fetch('config.yml', { cache: 'no-store' });
        cfgStatus = r.status; cfgType = r.headers.get('content-type') || '';
        const txt = await r.text(); cfgHead = txt.slice(0, 180).replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]));
      } catch (e) {
        log('Config fetch threw: '+String(e), 'err');
      }
      log(`config.yml → status <b>${cfgStatus}</b>, type <code>${cfgType}</code><br><small>head:</small> <code>${cfgHead}</code>`,
          cfgStatus===200 ? 'ok' : 'err');

      // Listen for Worker popup message and save token exactly how Decap expects
      window.addEventListener('message', (e) => {
        if (typeof e.data === 'string' && e.data.startsWith('authorization:github:success:')) {
          const token = e.data.split(':').pop();
          try {
            localStorage.setItem('decap-cms.user', JSON.stringify({ backendName:'github', login:'github', token }));
            log('Token saved to localStorage. Reloading to resume CMS…', 'ok');
            location.reload();
          } catch (err) {
            log('Failed to save token: '+String(err), 'err');
          }
        } else {
          // surface unexpected messages for visibility
          log('Other message: <code>'+String(e.data)+'</code>');
        }
      }, false);

      // Buttons
      document.getElementById('btn-auth').onclick = () => {
        const url = 'https://rp-cms-auth.james-c4d.workers.dev/auth';
        window.open(url, 'decap-auth', 'width=960,height=800');
        log('Opened auth popup: <code>'+url+'</code>');
      };
      document.getElementById('btn-reinit').onclick = () => {
        if (window.CMS && CMS.init) {
          CMS.init(); log('Called CMS.init()', 'ok');
        } else { log('CMS.init not available', 'err'); }
      };
      document.getElementById('btn-clear').onclick = () => {
        localStorage.removeItem('decap-cms.user'); log('Cleared saved token', 'warn');
      };

      // If token exists and config is 200 → init CMS
      if (raw && cfgStatus === 200) {
        log('<b>Step 3:</b> Starting CMS (token present, config OK)…');
        try { CMS.init(); log('CMS.init() called', 'ok'); } catch (e) {
          log('CMS.init threw: '+String(e), 'err');
        }
      } else if (cfgStatus !== 200) {
        log('Config not reachable as YAML. Ensure <code>/admin/config.yml</code> exists and is served as text/yaml.', 'err');
      } else {
        log('No token yet. Click <b>Open GitHub Login (Worker)</b> above.', 'warn');
      }
    } catch (e) {
      log('Boot error: '+String(e), 'err');
    }
  })();
  </script>
</body>
</html>
