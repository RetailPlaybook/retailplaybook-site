<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Retail Playbook CMS</title>
    <!-- Tell Decap not to auto-init from config.yml -->
    <script>window.CMS_MANUAL_INIT = true;</script>
  </head>
  <body>
    <div id="nc-root"></div>

    <!-- Helper: capture token from popup/hash and persist -->
    <script>
      (function () {
        function saveToken(t) {
          if (!t) return;
          const user = { backendName: 'github', login: 'github', token: t };
          localStorage.setItem('netlify-cms.user', JSON.stringify(user));
          localStorage.setItem('decap-cms.user', JSON.stringify(user));
        }
        window.addEventListener('message', function (e) {
          var s = String(e.data || '');
          if (s.includes('authorization:github:success:')) {
            saveToken(s.split('authorization:github:success:')[1].trim());
            location.reload();
          }
        });
        var m = location.hash.match(/access_token=([^&]+)/);
        if (m && m[1]) { saveToken(decodeURIComponent(m[1])); history.replaceState(null,'',location.pathname); location.reload(); }
      })();
    </script>

    <!-- Load Decap CMS from jsDelivr -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3/dist/decap-cms.js"></script>

    <!-- Fallback: if CMS didn't load in time, pull from unpkg (just once) -->
    <script>
      (function fallbackLoader(){
        setTimeout(function(){
          if (!window.CMS && !window.__cms_fallback_loaded) {
            window.__cms_fallback_loaded = true;
            var s = document.createElement('script');
            s.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
            document.body.appendChild(s);
          }
        }, 1500);
      })();
    </script>

    <!-- Wait for CMS to be available, then init ONCE -->
    <script>
      (function () {
        const REPO = "RetailPlaybook/retailplaybook-site"; // <- exact Owner/Repo (case-sensitive)
        const WORKER_BASE_URL = "https://rp-cms-auth.james-c4d.workers.dev";

        function startCMS() {
          if (window.__cms_started) return; // guard against double init
          window.__cms_started = true;

          CMS.init({
            config: {
              backend: {
                name: "github",
                repo: REPO,
                branch: "main",
                base_url: WORKER_BASE_URL,
                auth_endpoint: "/auth"
              },
              media_folder: "assets/uploads",
              public_folder: "/assets/uploads",
              collections: [
                {
                  name: "posts",
                  label: "Posts",
                  folder: "posts",
                  create: true,
                  slug: "{{year}}-{{month}}-{{day}}-{{slug}}",
                  extension: "html",
                  format: "frontmatter",
                  fields: [
                    { label: "Title", name: "title", widget: "string" },
                    { label: "Date", name: "date", widget: "date", format: "YYYY-MM-DD" },
                    { label: "Summary", name: "summary", widget: "text", required: false },
                    { label: "Cover Image", name: "image", widget: "image", required: false },
                    { label: "Tags", name: "tags", widget: "list", required: false },
                    { label: "Body (Markdown)", name: "body", widget: "markdown" }
                  ]
                }
              ]
            }
          });

          // simple proof it ran
          setTimeout(() => {
            try {
              const names = CMS.getConfig().get('collections').map(c => c.get('name')).toJS();
              console.log('[CMS] init complete; collections:', names);
            } catch (e) {
              console.log('[CMS] init not ready:', e.message);
            }
          }, 300);
        }

        (function waitForCMS(){
          if (window.CMS && typeof CMS.init === 'function') {
            startCMS();
          } else {
            setTimeout(waitForCMS, 50);
          }
        })();
      })();
    </script>
  </body>
</html>

