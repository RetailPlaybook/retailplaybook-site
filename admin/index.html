<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Retail Playbook CMS</title>

    <!-- Disable auto YAML init BEFORE loading the CMS script -->
    <script>window.CMS_MANUAL_INIT = true;</script>
  </head>
  <body>
    <div id="nc-root"></div>

    <!-- 1) Token helper: saves token from popup or URL hash -->
    <script>
      (function () {
        function saveToken(t) {
          if (!t) return;
          const user = { backendName: 'github', login: 'github', token: t };
          localStorage.setItem('decap-cms.user', JSON.stringify(user));
          localStorage.setItem('netlify-cms.user', JSON.stringify(user));
        }
        window.addEventListener('message', function (e) {
          const s = String(e.data || '');
          if (s.includes('authorization:github:success:')) {
            saveToken(s.split('authorization:github:success:')[1].trim());
            location.reload();
          }
        });
        // support hash-style token too
        const m = location.hash.match(/access_token=([^&]+)/);
        if (m && m[1]) {
          saveToken(decodeURIComponent(m[1]));
          history.replaceState(null, '', location.pathname);
          location.reload();
        }
      })();
    </script>

    <!-- 2) Load Decap CMS exactly once -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3/dist/decap-cms.js"></script>

    <!-- 3) Guarded manual init (cannot run twice) -->
    <script>
      (function () {
        const REPO   = "RetailPlaybook/retailplaybook-site";   // <- make sure this is exact Owner/Repo
        const WORKER = "https://rp-cms-auth.james-c4d.workers.dev";

        if (window.__CMS_INITED__) { console.warn("[CMS] init skipped"); return; }
        window.__CMS_INITED__ = true;

        CMS.init({
          config: {
            backend: { name: "github", repo: REPO, branch: "main", base_url: WORKER, auth_endpoint: "/auth" },
            media_folder: "assets/uploads",
            public_folder: "/assets/uploads",
            collections: [
              {
                name: "posts",
                label: "Posts",
                folder: "posts",
                create: true,
                slug: "{{year}}-{{month}}-{{day}}-{{slug}}",
                extension: "html",
                format: "frontmatter",
                fields: [
                  { label: "Title", name: "title", widget: "string" },
                  { label: "Date",  name: "date",  widget: "date",  format: "YYYY-MM-DD" },
                  { label: "Body",  name: "body",  widget: "markdown" }
                ]
              }
            ]
          }
        });
      })();
    </script>
  </body>
</html>

